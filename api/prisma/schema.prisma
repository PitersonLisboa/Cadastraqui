// ===========================================
// CADASTRAQUI - Schema do Banco de Dados
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum Role {
  ADMIN
  INSTITUICAO
  CANDIDATO
  SUPERVISAO
  CONTROLE
  OPERACIONAL
  ASSISTENTE_SOCIAL
  ADVOGADO
}

enum UF {
  AC
  AL
  AM
  AP
  BA
  CE
  DF
  ES
  GO
  MA
  MG
  MS
  MT
  PA
  PB
  PE
  PI
  PR
  RJ
  RN
  RO
  RR
  RS
  SC
  SE
  SP
  TO
}

enum StatusCandidatura {
  PENDENTE
  EM_ANALISE
  DOCUMENTACAO_PENDENTE
  APROVADO
  REPROVADO
  CANCELADO
}

enum StatusDocumento {
  PENDENTE
  ENVIADO
  APROVADO
  REJEITADO
}

// ===========================================
// MODELOS PRINCIPAIS
// ===========================================

model Usuario {
  id            String    @id @default(uuid())
  email         String    @unique
  senha         String
  nome          String?
  role          Role      @default(CANDIDATO)
  ativo         Boolean   @default(true)
  primeiroAcesso Boolean  @default(true)
  criadoEm      DateTime  @default(now())
  atualizadoEm  DateTime  @updatedAt

  // Multi-tenant: vínculo com instituição (nullable para ADMIN)
  instituicao       Instituicao? @relation("UsuariosInstituicao", fields: [instituicaoId], references: [id])
  instituicaoId     String?

  // Relacionamentos
  candidato         Candidato?
  responsavelLegal  ResponsavelLegal?
  instituicaoAdmin  Instituicao?      @relation("InstituicaoAdmin")
  assistenteSocial  AssistenteSocial?
  advogado          Advogado?
  supervisor        Supervisor?
  membroControle    MembroControle?
  membroOperacional MembroOperacional?
  sessoes           Sessao[]
  logs              LogAtividade[]
  historicosCandidatura HistoricoCandidatura[]
  notificacoes      Notificacao[]
  membroEquipe      MembroEquipe?
  tokensRecuperacao TokenRecuperacaoSenha[]

  @@map("usuarios")
}

model Sessao {
  id           String   @id @default(uuid())
  token        String   @unique
  userAgent    String?
  ip           String?
  expiraEm     DateTime
  criadoEm     DateTime @default(now())

  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId    String

  @@map("sessoes")
}

model TokenRecuperacaoSenha {
  id           String   @id @default(uuid())
  token        String   @unique
  expiraEm     DateTime
  usado        Boolean  @default(false)
  criadoEm     DateTime @default(now())

  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId    String

  @@map("tokens_recuperacao_senha")
}

// ===========================================
// CANDIDATO
// ===========================================

model Candidato {
  id                String   @id @default(uuid())
  nome              String
  cpf               String   @unique
  dataNascimento    DateTime?
  telefone          String?
  celular           String?
  
  // Endereço
  cep               String?
  endereco          String?
  numero            String?
  complemento       String?
  bairro            String?
  cidade            String?
  uf                String?

  // Documentos
  rg                String?
  rgEstado          String?
  rgOrgao           String?
  possuiComprovante Boolean?

  // Dados adicionais
  nomeSocial        String?
  sexo              String?
  profissao         String?
  nacionalidade     String?
  naturalidade      String?
  naturalidadeEstado String?

  // Estado civil
  estadoCivil       String?

  // Informações pessoais extra
  corRaca           String?
  escolaridade      String?
  religiao          String?
  necessidadesEspeciais Boolean? @default(false)
  tipoNecessidadesEspeciais String?
  descricaoNecessidadesEspeciais String?

  // Benefícios
  cadastroUnico     Boolean? @default(false)
  escolaPublica     Boolean? @default(false)
  bolsaCebasBasica  Boolean? @default(false)
  bolsaCebasProfissional Boolean? @default(false)

  // Renda
  rendaFamiliar     Decimal?
  
  criadoEm          DateTime @default(now())
  atualizadoEm      DateTime @updatedAt

  // Relacionamentos
  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId         String   @unique
  
  // Multi-tenant
  instituicao       Instituicao? @relation("CandidatoInstituicao", fields: [instituicaoId], references: [id])
  instituicaoId     String?
  
  responsavelLegal  ResponsavelLegal? @relation(fields: [responsavelId], references: [id])
  responsavelId     String?
  
  documentos        Documento[]
  candidaturas      Candidatura[]
  membrosFamilia    MembroFamilia[]
  despesas          DespesaMensal[]
  moradia           Moradia?
  veiculos          Veiculo[]
  saude             SaudeFamiliar[]
  fontesRenda       FonteRenda[]
  rendasMensais     RendaMensal[]

  @@map("candidatos")
}

// ===========================================
// MORADIA
// ===========================================

model Moradia {
  id              String   @id @default(uuid())
  statusMoradia   String?   // PROPRIA, ALUGADA, CEDIDA, FINANCIADA, etc.
  tipoMoradia     String?   // CASA, APARTAMENTO, KITNET, etc.
  tempoMoradia    String?   // MENOS_1_ANO, 1_A_3_ANOS, etc.
  qtdComodos      String?
  qtdDormitorios  Int?

  candidato       Candidato @relation(fields: [candidatoId], references: [id], onDelete: Cascade)
  candidatoId     String    @unique

  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("moradias")
}

// ===========================================
// VEÍCULO
// ===========================================

model Veiculo {
  id              String   @id @default(uuid())
  modelo          String
  placa           String?
  ano             String?

  candidato       Candidato @relation(fields: [candidatoId], references: [id], onDelete: Cascade)
  candidatoId     String

  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("veiculos")
}

model MembroFamilia {
  id              String   @id @default(uuid())
  nome            String
  cpf             String?
  dataNascimento  DateTime?
  parentesco      String
  renda           Decimal?
  ocupacao        String?
  fonteRenda      String?

  // Step 2 - Dados Pessoais
  telefone        String?
  email           String?
  rg              String?
  rgEstado        String?
  rgOrgao         String?

  // Step 3 - Informações Adicionais
  nomeSocial      String?
  sexo            String?
  profissao       String?
  nacionalidade   String?
  naturalidade    String?
  estado          String?

  // Step 4 - Estado Civil
  estadoCivil     String?

  // Step 5 - Informações Pessoais
  corRaca         String?
  escolaridade    String?
  religiao        String?
  necessidadesEspeciais           Boolean @default(false)
  tipoNecessidadesEspeciais       String?
  descricaoNecessidadesEspeciais  String?

  // Step 8 - Benefícios e Programas
  cadastroUnico          Boolean @default(false)
  escolaPublica          Boolean @default(false)
  bolsaCebasBasica       Boolean @default(false)
  bolsaCebasProfissional Boolean @default(false)

  candidato       Candidato @relation(fields: [candidatoId], references: [id], onDelete: Cascade)
  candidatoId     String

  rendaMensal     RendaMensal[]
  documentos      DocumentoMembro[]
  saude           SaudeFamiliar[]
  fontesRenda     FonteRenda[]

  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("membros_familia")
}

// ===========================================
// RENDA MENSAL (detalhamento por mês/fonte)
// ===========================================

model RendaMensal {
  id              String   @id @default(uuid())
  mes             Int      // 1-12
  ano             Int
  valor           Decimal
  fonte           String?  // campo antigo — mantido para backward compat
  descricao       String?
  comprovante     String?  // campo antigo URL — mantido para backward compat

  // Novos campos 2.x
  rendaBruta              Decimal? @default(0) @map("renda_bruta")
  auxilioAlimentacao       Decimal? @default(0) @map("auxilio_alimentacao")
  auxilioTransporte        Decimal? @default(0) @map("auxilio_transporte")
  adiantamentos            Decimal? @default(0)
  indenizacoes             Decimal? @default(0)
  estornosCompensacoes     Decimal? @default(0) @map("estornos_compensacoes")
  pensaoAlimenticiaPaga    Decimal? @default(0) @map("pensao_alimenticia_paga")
  comprovanteUrl           String?  @map("comprovante_url")
  comprovanteNome          String?  @map("comprovante_nome")

  // Vínculos (todos opcionais para backward compat)
  membro          MembroFamilia? @relation(fields: [membroId], references: [id], onDelete: Cascade)
  membroId        String?

  fonteRenda      FonteRenda? @relation(fields: [fonteRendaId], references: [id], onDelete: Cascade)
  fonteRendaId    String?     @map("fonte_renda_id")

  candidato       Candidato? @relation(fields: [candidatoId], references: [id], onDelete: Cascade)
  candidatoId     String?    @map("candidato_id")

  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("rendas_mensais")
}

// ===========================================
// FONTE DE RENDA (vínculo empregatício / ocupação)
// ===========================================

model FonteRenda {
  id                    String   @id @default(uuid())

  // Vínculo dual: candidato OU membro
  candidato             Candidato?     @relation(fields: [candidatoId], references: [id], onDelete: Cascade)
  candidatoId           String?        @map("candidato_id")
  membroFamilia         MembroFamilia? @relation(fields: [membroFamiliaId], references: [id], onDelete: Cascade)
  membroFamiliaId       String?        @map("membro_id")

  tipo                  String

  // Dados do vínculo (condicional por tipo)
  documentoEmpregador   String?  @map("documento_empregador")
  nomeFontePagadora     String?  @map("nome_fonte_pagadora")
  telefoneFonte         String?  @map("telefone_fonte")
  atividadeExercida     String?  @map("atividade_exercida")
  dataInicio            DateTime? @db.Date @map("data_inicio")

  // Benefício
  descricaoBeneficio    String?  @map("descricao_beneficio")
  numeroBeneficio       String?  @map("numero_beneficio")

  // Estudante
  instituicaoEnsino     String?  @map("instituicao_ensino")
  cursoSerie            String?  @map("curso_serie")
  comprovanteMatriculaUrl  String?  @map("comprovante_matricula_url")
  comprovanteMatriculaNome String?  @map("comprovante_matricula_nome")

  // Relação com rendas mensais
  rendasMensais         RendaMensal[]

  criadoEm              DateTime @default(now()) @map("criado_em")
  atualizadoEm          DateTime @updatedAt     @map("atualizado_em")

  @@map("fontes_renda")
}

// ===========================================
// DOCUMENTO DE MEMBRO FAMILIAR (tabela separada)
// Não afeta a tabela "documentos" do candidato
// ===========================================

model DocumentoMembro {
  id              String          @id @default(uuid())
  tipo            String
  nome            String
  url             String
  tamanho         Int?
  mimeType        String?
  status          StatusDocumento @default(PENDENTE)
  observacao      String?
  
  membroFamilia   MembroFamilia @relation(fields: [membroFamiliaId], references: [id], onDelete: Cascade)
  membroFamiliaId String
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("documentos_membros")
}

// ===========================================
// DESPESA MENSAL (gastos familiares por mês)
// ===========================================

model DespesaMensal {
  id              String   @id @default(uuid())
  mes             Int      // 1-12
  ano             Int
  categoria       String
  descricao       String?
  valor           Decimal
  comprovante     String?  // URL do comprovante
  naoSeAplica     Boolean  @default(false)
  justificativa   String?
  
  candidato       Candidato @relation(fields: [candidatoId], references: [id], onDelete: Cascade)
  candidatoId     String
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("despesas_mensais")
}

// ===========================================
// RESPONSÁVEL LEGAL (para menores)
// ===========================================

model ResponsavelLegal {
  id              String   @id @default(uuid())
  nome            String
  cpf             String   @unique
  dataNascimento  DateTime
  telefone        String
  
  // Endereço
  cep             String
  endereco        String
  numero          String
  complemento     String?
  bairro          String
  cidade          String
  uf              UF

  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  // Relacionamentos
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId       String   @unique
  
  dependentes     Candidato[]

  @@map("responsaveis_legais")
}

// ===========================================
// INSTITUIÇÃO
// ===========================================

model Instituicao {
  id                      String   @id @default(uuid())
  razaoSocial             String
  nomeFantasia            String?
  cnpj                    String   @unique
  telefone                String
  email                   String
  status                  String   @default("PENDENTE") // PENDENTE, ATIVA, SUSPENSA, INATIVA
  
  // Endereço
  cep                     String
  endereco                String
  numero                  String
  complemento             String?
  bairro                  String
  cidade                  String
  uf                      UF

  // Dados institucionais
  codigoMEC               String?
  tipoInstituicao         String?
  
  criadoEm                DateTime @default(now())
  atualizadoEm            DateTime @updatedAt

  // Relacionamentos
  usuario                 Usuario  @relation("InstituicaoAdmin", fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId               String   @unique
  
  // Multi-tenant
  usuarios                Usuario[]  @relation("UsuariosInstituicao")
  tenant                  Tenant?
  candidatos              Candidato[] @relation("CandidatoInstituicao")
  
  assistentesSociais      AssistenteSocial[]
  advogados               Advogado[]
  supervisores            Supervisor[]
  membrosControle         MembroControle[]
  membrosOperacional      MembroOperacional[]
  editais                 Edital[]
  unidades                UnidadeInstituicao[]
  membrosEquipe           MembroEquipe[]
  documentos              DocumentoInstituicao[]
  convitesEquipe          ConviteEquipe[]
  notificacoes            Notificacao[]
  logsAtividade           LogAtividade[]
  configuracoes           Configuracao[]

  @@map("instituicoes")
}

// ===========================================
// TENANT (Personalização por instituição)
// ===========================================

model Tenant {
  id              String   @id @default(uuid())
  slug            String   @unique  // "PUCMinas", "Metodista"
  nome            String
  logoUrl         String?
  corPrimaria     String?  @default("#1e40af")
  corSecundaria   String?  @default("#3b82f6")
  dominio         String?
  ativo           Boolean  @default(true)
  configuracoes   Json?

  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id])
  instituicaoId   String      @unique

  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("tenants")
}

model DocumentoInstituicao {
  id              String   @id @default(uuid())
  nome            String
  tipo            String
  categoria       String   @default("OUTRO") // INSTITUCIONAL, REGULAMENTO, MODELO, CONTRATO, RELATORIO, OUTRO
  tamanho         Int
  url             String
  
  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id], onDelete: Cascade)
  instituicaoId   String
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("documentos_instituicao")
}

model UnidadeInstituicao {
  id              String   @id @default(uuid())
  nome            String
  cnpj            String?
  telefone        String?
  
  // Endereço
  cep             String
  endereco        String
  numero          String
  complemento     String?
  bairro          String
  cidade          String
  uf              UF

  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id], onDelete: Cascade)
  instituicaoId   String
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("unidades_instituicao")
}

// ===========================================
// ASSISTENTE SOCIAL
// ===========================================

model AssistenteSocial {
  id              String   @id @default(uuid())
  nome            String
  cress           String   // Registro no Conselho
  telefone        String?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  // Relacionamentos
  usuario         Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId       String      @unique
  
  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id])
  instituicaoId   String
  
  pareceres       ParecerSocial[]
  agendamentos    Agendamento[]

  @@map("assistentes_sociais")
}

model ParecerSocial {
  id                String   @id @default(uuid())
  parecer           String   @db.Text
  recomendacao      String?
  dataEmissao       DateTime @default(now())
  
  assistenteSocial  AssistenteSocial @relation(fields: [assistenteId], references: [id])
  assistenteId      String
  
  candidatura       Candidatura @relation(fields: [candidaturaId], references: [id])
  candidaturaId     String      @unique
  
  criadoEm          DateTime @default(now())
  atualizadoEm      DateTime @updatedAt

  @@map("pareceres_sociais")
}

// ===========================================
// ADVOGADO
// ===========================================

model Advogado {
  id              String   @id @default(uuid())
  nome            String
  oab             String   // Número da OAB
  oabUf           UF
  telefone        String?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  // Relacionamentos
  usuario         Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId       String      @unique
  
  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id])
  instituicaoId   String
  
  pareceresJuridicos ParecerJuridico[]

  @@map("advogados")
}

model ParecerJuridico {
  id              String   @id @default(uuid())
  parecer         String   @db.Text
  fundamentacao   String?  @db.Text
  recomendacao    String?  // DEFERIDO, INDEFERIDO, DILIGENCIA
  dataEmissao     DateTime @default(now())
  
  advogado        Advogado @relation(fields: [advogadoId], references: [id])
  advogadoId      String
  
  candidatura     Candidatura @relation(fields: [candidaturaId], references: [id])
  candidaturaId   String      @unique
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("pareceres_juridicos")
}

// ===========================================
// SUPERVISOR (Coordenador do setor social)
// Mesmas funções do AS, mas NÃO defere/indefere
// ===========================================

model Supervisor {
  id              String   @id @default(uuid())
  nome            String
  registro        String?  // Registro profissional opcional
  telefone        String?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  usuario         Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId       String      @unique
  
  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id])
  instituicaoId   String

  @@map("supervisores")
}

// ===========================================
// MEMBRO CONTROLE (Instância superior de consulta)
// Visualização e encaminhamentos, sem decisão
// ===========================================

model MembroControle {
  id              String   @id @default(uuid())
  nome            String
  cargo           String?
  telefone        String?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  usuario         Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId       String      @unique
  
  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id])
  instituicaoId   String

  @@map("membros_controle")
}

// ===========================================
// MEMBRO OPERACIONAL (Equipe de pré-análise)
// Analisa docs, faz solicitações, NÃO finaliza parecer
// ===========================================

model MembroOperacional {
  id              String   @id @default(uuid())
  nome            String
  cargo           String?
  telefone        String?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  usuario         Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId       String      @unique
  
  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id])
  instituicaoId   String

  @@map("membros_operacional")
}

// ===========================================
// EDITAL E CANDIDATURA
// ===========================================

model Edital {
  id                String   @id @default(uuid())
  titulo            String
  descricao         String?  @db.Text
  anoLetivo         Int
  dataInicio        DateTime
  dataFim           DateTime
  vagasDisponiveis  Int
  requisitos        String?  @db.Text
  documentosExigidos String? @db.Text
  ativo             Boolean  @default(true)
  
  instituicao       Instituicao @relation(fields: [instituicaoId], references: [id])
  instituicaoId     String
  
  candidaturas      Candidatura[]
  
  criadoEm          DateTime @default(now())
  atualizadoEm      DateTime @updatedAt

  @@map("editais")
}

model Candidatura {
  id              String            @id @default(uuid())
  status          StatusCandidatura @default(PENDENTE)
  dataInscricao   DateTime          @default(now())
  observacoes     String?           @db.Text
  
  candidato       Candidato @relation(fields: [candidatoId], references: [id])
  candidatoId     String
  
  edital          Edital @relation(fields: [editalId], references: [id])
  editalId        String
  
  documentos      DocumentoCandidatura[]
  parecerSocial   ParecerSocial?
  parecerJuridico ParecerJuridico?
  agendamentos    Agendamento[]
  historico       HistoricoCandidatura[]
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@unique([candidatoId, editalId])
  @@map("candidaturas")
}

model HistoricoCandidatura {
  id              String            @id @default(uuid())
  status          StatusCandidatura
  observacao      String?
  
  candidatura     Candidatura @relation(fields: [candidaturaId], references: [id], onDelete: Cascade)
  candidaturaId   String
  
  usuario         Usuario @relation(fields: [usuarioId], references: [id])
  usuarioId       String
  
  createdAt       DateTime @default(now())

  @@map("historico_candidatura")
}

// ===========================================
// SAÚDE FAMILIAR (doença + medicação por pessoa)
// ===========================================

model SaudeFamiliar {
  id                    String   @id @default(uuid())

  // Vínculo: candidato OU membro
  candidato             Candidato?     @relation(fields: [candidatoId], references: [id], onDelete: Cascade)
  candidatoId           String?
  membroFamilia         MembroFamilia? @relation(fields: [membroFamiliaId], references: [id], onDelete: Cascade)
  membroFamiliaId       String?

  // Step 1: Doença
  possuiDoenca              Boolean @default(false)
  doenca                    String?
  possuiRelatorioMedico     Boolean @default(false)
  laudoUrl                  String?
  laudoNome                 String?
  laudoTamanho              Int?
  laudoMimeType             String?

  // Step 2: Medicação
  tomaMedicamentoControlado Boolean @default(false)
  nomeMedicamento           String?
  obtemRedePublica          Boolean @default(false)
  especifiqueRedePublica    String?
  receitaUrl                String?
  receitaNome               String?
  receitaTamanho            Int?
  receitaMimeType           String?

  criadoEm              DateTime @default(now())
  atualizadoEm          DateTime @updatedAt

  @@map("saude_familiar")
}

// ===========================================
// DOCUMENTOS
// ===========================================

model Documento {
  id              String          @id @default(uuid())
  tipo            String
  nome            String
  url             String
  tamanho         Int?
  mimeType        String?
  status          StatusDocumento @default(PENDENTE)
  observacao      String?
  
  candidato       Candidato @relation(fields: [candidatoId], references: [id], onDelete: Cascade)
  candidatoId     String
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("documentos")
}

model DocumentoCandidatura {
  id              String          @id @default(uuid())
  tipo            String
  nome            String
  url             String
  status          StatusDocumento @default(PENDENTE)
  observacao      String?
  
  candidatura     Candidatura @relation(fields: [candidaturaId], references: [id], onDelete: Cascade)
  candidaturaId   String
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("documentos_candidatura")
}

// ===========================================
// AGENDAMENTO
// ===========================================

model Agendamento {
  id              String   @id @default(uuid())
  titulo          String
  descricao       String?
  dataHora        DateTime
  duracao         Int      @default(30) // minutos
  local           String?
  linkOnline      String?
  realizado       Boolean  @default(false)
  observacoes     String?  @db.Text
  
  candidatura     Candidatura @relation(fields: [candidaturaId], references: [id])
  candidaturaId   String
  
  assistenteSocial AssistenteSocial @relation(fields: [assistenteId], references: [id])
  assistenteId    String
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("agendamentos")
}

// ===========================================
// NOTIFICAÇÕES
// ===========================================

enum TipoNotificacao {
  INFO
  SUCESSO
  ALERTA
  ERRO
}

model Notificacao {
  id          String           @id @default(uuid())
  tipo        TipoNotificacao  @default(INFO)
  titulo      String
  mensagem    String
  lida        Boolean          @default(false)
  link        String?
  
  usuario     Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId   String
  
  // Multi-tenant
  instituicao   Instituicao? @relation(fields: [instituicaoId], references: [id])
  instituicaoId String?
  
  criadoEm    DateTime         @default(now())

  @@map("notificacoes")
}

// ===========================================
// LOGS E AUDITORIA
// ===========================================

model LogAtividade {
  id          String   @id @default(uuid())
  acao        String
  entidade    String
  entidadeId  String?
  detalhes    Json?
  ip          String?
  userAgent   String?
  
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
  usuarioId   String
  
  // Multi-tenant
  instituicao   Instituicao? @relation(fields: [instituicaoId], references: [id])
  instituicaoId String?
  
  criadoEm    DateTime @default(now())

  @@map("logs_atividade")
}

// ===========================================
// MEMBROS DA EQUIPE (Instituição)
// ===========================================

model MembroEquipe {
  id              String   @id @default(uuid())
  nome            String
  email           String
  cargo           String?
  role            Role
  ativo           Boolean  @default(true)
  
  instituicao     Instituicao @relation(fields: [instituicaoId], references: [id], onDelete: Cascade)
  instituicaoId   String
  
  usuario         Usuario? @relation(fields: [usuarioId], references: [id])
  usuarioId       String?  @unique
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt

  @@map("membros_equipe")
}

// ===========================================
// CONVITES DE EQUIPE
// ===========================================

model ConviteEquipe {
  id            String   @id @default(uuid())
  codigo        String   @unique
  tipo          Role     // ASSISTENTE_SOCIAL ou ADVOGADO
  email         String?  // Email opcional para quem o convite foi destinado
  usado         Boolean  @default(false)
  usadoPor      String?  // ID do usuário que usou o convite
  expiraEm      DateTime
  
  instituicao   Instituicao @relation(fields: [instituicaoId], references: [id], onDelete: Cascade)
  instituicaoId String
  
  criadoEm      DateTime @default(now())

  @@map("convites_equipe")
}

// ===========================================
// CONFIGURAÇÕES DO SISTEMA
// ===========================================

model Configuracao {
  id        String   @id @default(uuid())
  chave     String
  valor     String
  descricao String?
  
  // Multi-tenant (null = configuração global)
  instituicao   Instituicao? @relation(fields: [instituicaoId], references: [id])
  instituicaoId String?
  
  criadoEm  DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@unique([chave, instituicaoId])
  @@map("configuracoes")
}
